{% extends "admin/base_site.html" %}
{% load i18n admin_urls static admin_modify %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block breadcrumbs %}
<div class="breadcrumbs">
<a href="{% url 'admin:index' %}">{% trans 'Home' %}</a>
&rsaquo; <a href="{% url 'admin:app_list' app_label=opts.app_label %}">{{ opts.app_config.verbose_name }}</a>
&rsaquo; {{ title }}
</div>
{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="module">
    <h2>ä¼šå‘˜ç»Ÿè®¡</h2>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-number">{{ total_users }}</div>
            <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ premium_users }}</div>
            <div class="stat-label">é«˜çº§ä¼šå‘˜æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ active_premium_users }}</div>
            <div class="stat-label">æœ‰æ•ˆä¼šå‘˜æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-number">{{ expired_premium_users }}</div>
            <div class="stat-label">è¿‡æœŸä¼šå‘˜æ•°</div>
        </div>
    </div>
</div>

<!-- æœ€è¿‘è®¢å• -->
<div class="module">
    <h2>æœ€è¿‘è®¢å•</h2>
    <div class="results">
        <table>
            <thead>
                <tr>
                    <th>è®¢å•å·</th>
                    <th>ç”¨æˆ·</th>
                    <th>å¥—é¤</th>
                    <th>é‡‘é¢</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                </tr>
            </thead>
            <tbody>
                {% for order in recent_orders %}
                <tr>
                    <td><a href="{% url 'admin:user_membershiporder_change' order.id %}">{{ order.order_id }}</a></td>
                    <td><a href="{% url 'admin:user_user_change' order.user.id %}">{{ order.user.email }}</a></td>
                    <td>{{ order.plan.name }}</td>
                    <td>Â¥{{ order.amount }}</td>
                    <td>
                        {% if order.status == 'paid' %}
                            <span class="status-paid">å·²æ”¯ä»˜</span>
                        {% elif order.status == 'pending' %}
                            <span class="status-pending">å¾…æ”¯ä»˜</span>
                        {% elif order.status == 'cancelled' %}
                            <span class="status-cancelled">å·²å–æ¶ˆ</span>
                        {% else %}
                            {{ order.get_status_display }}
                        {% endif %}
                    </td>
                    <td>{{ order.created_at|date:"Y-m-d H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">æš‚æ— è®¢å•</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ç”¨æˆ·ç®¡ç† -->
<div class="module">
    <h2>ç”¨æˆ·ç®¡ç†</h2>
    
    <!-- æœç´¢å’Œç­›é€‰ -->
    <div class="search-form">
        <form method="get">
            <input type="text" name="search" value="{{ search_query }}" placeholder="æœç´¢ç”¨æˆ·é‚®ç®±...">
            <select name="filter">
                <option value="all" {% if filter_type == 'all' %}selected{% endif %}>æ‰€æœ‰ç”¨æˆ·</option>
                <option value="premium" {% if filter_type == 'premium' %}selected{% endif %}>é«˜çº§ä¼šå‘˜</option>
                <option value="regular" {% if filter_type == 'regular' %}selected{% endif %}>æ™®é€šç”¨æˆ·</option>
                <option value="expired" {% if filter_type == 'expired' %}selected{% endif %}>è¿‡æœŸä¼šå‘˜</option>
            </select>
            <input type="submit" value="æœç´¢">
        </form>
    </div>
    
    <!-- æ‰¹é‡æ“ä½œè¡¨å• -->
    <form method="post" id="membership-form">
        {% csrf_token %}
        <div class="batch-actions">
            <select name="action" id="action-select">
                <option value="">é€‰æ‹©æ“ä½œ...</option>
                <option value="set_premium">è®¾ç½®ä¸ºé«˜çº§ä¼šå‘˜</option>
                <option value="extend_premium">å»¶é•¿ä¼šå‘˜æ—¶é—´</option>
                <option value="remove_premium">ç§»é™¤ä¼šå‘˜æƒé™</option>
            </select>
            <input type="number" name="days" id="days-input" placeholder="å¤©æ•°" min="1" value="30" style="display:none;">
            <input type="submit" value="æ‰§è¡Œ" class="button">
        </div>
        
        <div class="results">
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select-all"></th>
                        <th>é‚®ç®±</th>
                        <th>ç”¨æˆ·å</th>
                        <th>ä¼šå‘˜çŠ¶æ€</th>
                        <th>åˆ°æœŸæ—¶é—´</th>
                        <th>ç§¯åˆ†</th>
                        <th>æ³¨å†Œæ—¶é—´</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users_list %}
                    <tr>
                        <td><input type="checkbox" name="user_ids" value="{{ user.id }}"></td>
                        <td><a href="{% url 'admin:user_user_change' user.id %}">{{ user.email }}</a></td>
                        <td>{{ user.username|default:"-" }}</td>
                        <td>
                            {% if user.is_premium_active %}
                                <span class="status-premium">ğŸ”¥ é«˜çº§ä¼šå‘˜</span>
                            {% else %}
                                <span class="status-regular">ğŸ‘¤ æ™®é€šç”¨æˆ·</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if user.premium_expires_at %}
                                {{ user.premium_expires_at|date:"Y-m-d H:i" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ user.points }}</td>
                        <td>{{ user.created_at|date:"Y-m-d" }}</td>
                        <td>
                            <a href="{% url 'admin:user_user_change' user.id %}" class="button">ç¼–è¾‘</a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8">æ²¡æœ‰æ‰¾åˆ°ç”¨æˆ·</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // å…¨é€‰åŠŸèƒ½
    const selectAll = document.getElementById('select-all');
    const checkboxes = document.querySelectorAll('input[name="user_ids"]');
    
    selectAll.addEventListener('change', function() {
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
        });
    });
    
    // æ“ä½œé€‰æ‹©å˜åŒ–æ—¶æ˜¾ç¤º/éšè—å¤©æ•°è¾“å…¥
    const actionSelect = document.getElementById('action-select');
    const daysInput = document.getElementById('days-input');
    
    actionSelect.addEventListener('change', function() {
        if (this.value === 'set_premium' || this.value === 'extend_premium') {
            daysInput.style.display = 'inline-block';
        } else {
            daysInput.style.display = 'none';
        }
    });
});
</script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    padding: 20px;
}

.stat-item {
    text-align: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.stat-number {
    font-size: 2em;
    font-weight: bold;
    color: #007cba;
    margin-bottom: 5px;
}

.stat-label {
    color: #666;
    font-size: 0.9em;
}

.search-form {
    padding: 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.search-form input, .search-form select {
    margin-right: 10px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.batch-actions {
    padding: 15px;
    background: #f0f0f0;
    border-bottom: 1px solid #ddd;
}

.batch-actions select, .batch-actions input {
    margin-right: 10px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

.status-paid { color: #28a745; font-weight: bold; }
.status-pending { color: #ffc107; font-weight: bold; }
.status-cancelled { color: #dc3545; font-weight: bold; }
.status-premium { color: #ffc107; font-weight: bold; }
.status-regular { color: #6c757d; }

.module h2 {
    margin: 0;
    padding: 8px 10px;
    font-size: 13px;
    text-align: left;
    font-weight: normal;
    background: #79aec8;
    color: white;
}

.results table {
    width: 100%;
    border-collapse: collapse;
}

.results th, .results td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.results th {
    background: #f8f9fa;
    font-weight: bold;
}

.button {
    display: inline-block;
    padding: 5px 10px;
    background: #007cba;
    color: white;
    text-decoration: none;
    border-radius: 3px;
    border: none;
    cursor: pointer;
    font-size: 12px;
}

.button:hover {
    background: #005a87;
}
</style>
{% endblock %}
